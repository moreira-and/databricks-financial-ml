# .github/workflows/ci-verificacao-codigo.yml
name: CI - Verifica√ß√£o de C√≥digo

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint-and-format:
    name: Linting e Formata√ß√£o
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do c√≥digo
      uses: actions/checkout@v4
      
    - name: Configurar Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
        
    - name: Instalar depend√™ncias de desenvolvimento
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort pylint mypy
        
    - name: Verificar formata√ß√£o com Black
      run: |
        black --check --diff transformacoes/ pipelines/ utilitarios/
      continue-on-error: false
      
    - name: Verificar imports com isort
      run: |
        isort --check-only --diff transformacoes/ pipelines/ utilitarios/
      continue-on-error: false
      
    - name: An√°lise est√°tica com Flake8
      run: |
        # Ignora erros de imports do Databricks (dlt, pyspark quando n√£o instalado)
        flake8 transformacoes/ pipelines/ utilitarios/ \
          --max-line-length=100 \
          --extend-ignore=E203,W503,F401 \
          --per-file-ignores="__init__.py:F401,transformacoes/bronze.py:F821,transformacoes/prata.py:F821,transformacoes/ouro.py:F821,utilitarios/fontes_dados.py:F821" \
          --exclude=.git,__pycache__,.venv,venv,build,dist
      continue-on-error: false

  security-scan:
    name: Verifica√ß√£o de Seguran√ßa
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do c√≥digo
      uses: actions/checkout@v4
      
    - name: Configurar Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Instalar Bandit
      run: |
        pip install bandit[toml]
        
    - name: An√°lise de seguran√ßa com Bandit
      run: |
        bandit -r transformacoes/ pipelines/ utilitarios/ \
          -f json -o bandit-report.json \
          --severity-level medium \
          --confidence-level medium
      continue-on-error: true
      
    - name: Upload do relat√≥rio de seguran√ßa
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: bandit-security-report
        path: bandit-report.json

  code-quality:
    name: Qualidade de C√≥digo
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do c√≥digo
      uses: actions/checkout@v4
      
    - name: Configurar Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
        
    - name: Instalar depend√™ncias
      run: |
        pip install pylint radon
        
    - name: An√°lise com Pylint
      run: |
        pylint transformacoes/ pipelines/ utilitarios/ \
          --disable=import-error,no-name-in-module,no-member \
          --max-line-length=100 \
          --output-format=text \
          --reports=y \
          --exit-zero > pylint-report.txt
        cat pylint-report.txt
      continue-on-error: true
      
    - name: An√°lise de complexidade ciclom√°tica
      run: |
        radon cc transformacoes/ pipelines/ utilitarios/ -a -s
        radon mi transformacoes/ pipelines/ utilitarios/ -s
      continue-on-error: true
      
    - name: Upload do relat√≥rio Pylint
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: pylint-report
        path: pylint-report.txt

  test-syntax:
    name: Valida√ß√£o de Sintaxe
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do c√≥digo
      uses: actions/checkout@v4
      
    - name: Configurar Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Instalar depend√™ncias m√≠nimas
      run: |
        pip install pandas requests
        
    - name: Verificar sintaxe Python
      run: |
        python -m py_compile transformacoes/*.py
        python -m py_compile pipelines/*.py
        python -m py_compile utilitarios/*.py
        
    - name: Verificar imports (exceto Databricks)
      run: |
        # Cria estrutura de pacotes mock para bibliotecas do Databricks
        mkdir -p mock_libs/pyspark/sql
        
        # Mock do m√≥dulo dlt
        cat > mock_libs/dlt.py << 'EOF'
        """Mock do m√≥dulo dlt para valida√ß√£o local."""
        def table(*args, **kwargs):
            def decorator(func):
                return func
            return decorator
        
        def expect(*args, **kwargs):
            def decorator(func):
                return func
            return decorator
        
        def expect_or_drop(*args, **kwargs):
            def decorator(func):
                return func
            return decorator
        
        def expect_or_fail(*args, **kwargs):
            def decorator(func):
                return func
            return decorator
        
        def view(*args, **kwargs):
            def decorator(func):
                return func
            return decorator
        
        def read(*args, **kwargs):
            pass
        
        def read_stream(*args, **kwargs):
            pass
        EOF
        
        # Mock do pyspark/__init__.py
        cat > mock_libs/pyspark/__init__.py << 'EOF'
        """Mock do pacote PySpark para valida√ß√£o local."""
        __version__ = "3.5.0"
        EOF
        
        # Mock do pyspark/sql/__init__.py
        cat > mock_libs/pyspark/sql/__init__.py << 'EOF'
        """Mock do m√≥dulo pyspark.sql para valida√ß√£o local."""

        class DataFrame:
            """Mock do DataFrame do PySpark."""
            def __init__(self):
                pass
            
            def count(self):
                return 0
            
            def repartition(self, *args):
                return self
            
            def sortWithinPartitions(self, *args):
                return self
            
            def select(self, *args):
                return self
            
            def filter(self, *args):
                return self
            
            def withColumn(self, *args):
                return self
            
            def join(self, *args, **kwargs):
                return self

        class types:
            """Mock dos tipos do PySpark."""
            
            class DataType:
                pass
            
            class StructType:
                def __init__(self, fields=None):
                    self.fields = fields or []
                    
                def fieldNames(self):
                    return [f.name for f in self.fields]
            
            class StructField:
                def __init__(self, name, dataType, nullable=True):
                    self.name = name
                    self.dataType = dataType
                    self.nullable = nullable
            
            class StringType(DataType):
                pass
            
            class IntegerType(DataType):
                pass
            
            class LongType(DataType):
                pass
            
            class DoubleType(DataType):
                pass
            
            class FloatType(DataType):
                pass
            
            class TimestampType(DataType):
                pass
            
            class DateType(DataType):
                pass
            
            class BooleanType(DataType):
                pass
            
            class ArrayType(DataType):
                def __init__(self, elementType):
                    self.elementType = elementType

        # Alias para compatibilidade
        T = types

        class SparkSession:
            """Mock da SparkSession."""
            
            def __init__(self):
                pass
            
            def createDataFrame(self, data, schema=None):
                return DataFrame()
            
            @property
            def builder(self):
                return self
            
            def appName(self, name):
                return self
            
            def getOrCreate(self):
                return self

        # Inst√¢ncia global mock do spark
        spark = SparkSession()
        EOF
        
        # Adiciona mocks ao PYTHONPATH e valida imports
        export PYTHONPATH="${PYTHONPATH}:$(pwd)/mock_libs"
        
        echo "Validando imports do m√≥dulo bronze..."
        python -c "import sys; sys.path.insert(0, 'mock_libs'); import transformacoes.bronze; print('‚úÖ bronze.py OK')"
        
        echo "Validando imports do m√≥dulo prata..."
        python -c "import sys; sys.path.insert(0, 'mock_libs'); import transformacoes.prata; print('‚úÖ prata.py OK')"
        
        echo "Validando imports do m√≥dulo ouro..."
        python -c "import sys; sys.path.insert(0, 'mock_libs'); import transformacoes.ouro; print('‚úÖ ouro.py OK')"
        
        echo "Validando imports do m√≥dulo configuracoes..."
        python -c "import utilitarios.configuracoes; print('‚úÖ configuracoes.py OK')"
        
        echo "Validando imports do m√≥dulo fontes_dados..."
        python -c "import sys; sys.path.insert(0, 'mock_libs'); import utilitarios.fontes_dados; print('‚úÖ fontes_dados.py OK')"
        
        echo "Validando imports do pipeline..."
        python -c "import sys; sys.path.insert(0, 'mock_libs'); import pipelines.pipeline_financeiro; print('‚úÖ pipeline_financeiro.py OK')"

  documentation-check:
    name: Verifica√ß√£o de Documenta√ß√£o
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do c√≥digo
      uses: actions/checkout@v4
      
    - name: Configurar Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Instalar pydocstyle
      run: |
        pip install pydocstyle
        
    - name: Verificar docstrings
      run: |
        pydocstyle transformacoes/ pipelines/ utilitarios/ \
          --convention=google \
          --add-ignore=D100,D104 \
          --match='(?!test_).*\.py'
      continue-on-error: true

  dependency-check:
    name: Verifica√ß√£o de Depend√™ncias
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do c√≥digo
      uses: actions/checkout@v4
      
    - name: Configurar Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Verificar vulnerabilidades com Safety
      run: |
        pip install safety
        # Cria requirements.txt tempor√°rio com depend√™ncias conhecidas
        cat > requirements-check.txt << EOF
        pandas>=1.5.0
        requests>=2.28.0
        EOF
        safety check --file requirements-check.txt --output text
      continue-on-error: true

  summary:
    name: Resumo da Verifica√ß√£o
    runs-on: ubuntu-latest
    needs: [lint-and-format, security-scan, code-quality, test-syntax, documentation-check, dependency-check]
    if: always()
    
    steps:
    - name: Verificar status dos jobs
      run: |
        echo "## üìä Resumo da Verifica√ß√£o CI" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Linting e Formata√ß√£o | ${{ needs.lint-and-format.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Verifica√ß√£o de Seguran√ßa | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Qualidade de C√≥digo | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Valida√ß√£o de Sintaxe | ${{ needs.test-syntax.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Verifica√ß√£o de Documenta√ß√£o | ${{ needs.documentation-check.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Verifica√ß√£o de Depend√™ncias | ${{ needs.dependency-check.result }} |" >> $GITHUB_STEP_SUMMARY
        
    - name: Falhar se jobs cr√≠ticos falharam
      if: needs.lint-and-format.result == 'failure' || needs.test-syntax.result == 'failure'
      run: |
        echo "‚ùå Jobs cr√≠ticos falharam. Verifique os logs acima."
        exit 1

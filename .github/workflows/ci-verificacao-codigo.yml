name: CI - Verifica√ß√£o de C√≥digo

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint-and-format:
    name: Linting e Formata√ß√£o
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do c√≥digo
      uses: actions/checkout@v4
      
    - name: Configurar Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
        
    - name: Instalar depend√™ncias de desenvolvimento
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort
        
    - name: Verificar formata√ß√£o com Black (n√£o falha o CI)
      run: |
        black --check --diff transformacoes/ pipelines/ utilitarios/
      continue-on-error: true
      
    - name: Verificar imports com isort (n√£o falha o CI)
      run: |
        isort --check-only --diff transformacoes/ pipelines/ utilitarios/
      continue-on-error: true
      
    - name: An√°lise est√°tica com Flake8
      run: |
        flake8 transformacoes/ pipelines/ utilitarios/ \
          --max-line-length=100 \
          --extend-ignore=E203,W503,F401,F821 \
          --per-file-ignores="__init__.py:F401" \
          --exclude=.git,__pycache__,.venv,venv,build,dist

  security-scan:
    name: Verifica√ß√£o de Seguran√ßa
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do c√≥digo
      uses: actions/checkout@v4
      
    - name: Configurar Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Instalar Bandit
      run: |
        pip install bandit[toml]
        
    - name: An√°lise de seguran√ßa com Bandit
      run: |
        bandit -r transformacoes/ pipelines/ utilitarios/ \
          -f json -o bandit-report.json \
          --severity-level medium \
          --confidence-level medium || true
      
    - name: Upload do relat√≥rio de seguran√ßa
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: bandit-security-report
        path: bandit-report.json

  code-quality:
    name: Qualidade de C√≥digo
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do c√≥digo
      uses: actions/checkout@v4
      
    - name: Configurar Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
        
    - name: Instalar depend√™ncias
      run: |
        pip install pylint radon
        
    - name: An√°lise com Pylint
      run: |
        pylint transformacoes/ pipelines/ utilitarios/ \
          --disable=import-error,no-name-in-module,no-member \
          --max-line-length=100 \
          --output-format=text \
          --reports=y \
          --exit-zero > pylint-report.txt
        cat pylint-report.txt
      
    - name: An√°lise de complexidade ciclom√°tica
      run: |
        radon cc transformacoes/ pipelines/ utilitarios/ -a -s || true
        radon mi transformacoes/ pipelines/ utilitarios/ -s || true
      
    - name: Upload do relat√≥rio Pylint
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: pylint-report
        path: pylint-report.txt

  syntax-check:
    name: Verifica√ß√£o de Sintaxe
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do c√≥digo
      uses: actions/checkout@v4
      
    - name: Configurar Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Verificar sintaxe Python
      run: |
        echo "Verificando sintaxe dos arquivos Python..."
        python -m py_compile transformacoes/*.py
        python -m py_compile pipelines/*.py
        python -m py_compile utilitarios/*.py
        echo "‚úÖ Todos os arquivos t√™m sintaxe v√°lida!"

  documentation-check:
    name: Verifica√ß√£o de Documenta√ß√£o
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do c√≥digo
      uses: actions/checkout@v4
      
    - name: Configurar Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Instalar pydocstyle
      run: |
        pip install pydocstyle
        
    - name: Verificar docstrings
      run: |
        pydocstyle transformacoes/ pipelines/ utilitarios/ \
          --convention=google \
          --add-ignore=D100,D104 \
          --match='(?!test_).*\.py' || true

  dependency-check:
    name: Verifica√ß√£o de Depend√™ncias
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do c√≥digo
      uses: actions/checkout@v4
      
    - name: Configurar Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Verificar vulnerabilidades com Safety
      run: |
        pip install safety
        cat > requirements-check.txt << EOF
        pandas>=1.5.0
        requests>=2.28.0
        EOF
        safety check --file requirements-check.txt --output text || true

  summary:
    name: Resumo da Verifica√ß√£o
    runs-on: ubuntu-latest
    needs: [lint-and-format, security-scan, code-quality, syntax-check, documentation-check, dependency-check]
    if: always()
    
    steps:
    - name: Verificar status dos jobs
      run: |
        echo "## üìä Resumo da Verifica√ß√£o CI" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Linting e Formata√ß√£o | ${{ needs.lint-and-format.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Verifica√ß√£o de Seguran√ßa | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Qualidade de C√≥digo | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Verifica√ß√£o de Sintaxe | ${{ needs.syntax-check.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Verifica√ß√£o de Documenta√ß√£o | ${{ needs.documentation-check.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Verifica√ß√£o de Depend√™ncias | ${{ needs.dependency-check.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "‚ö†Ô∏è Nota: Black/isort est√£o em modo de aviso (n√£o quebram o CI)." >> $GITHUB_STEP_SUMMARY
        echo "‚ö†Ô∏è Imports espec√≠ficos de Databricks (PySpark, DLT) n√£o s√£o verificados no CI." >> $GITHUB_STEP_SUMMARY
        
    - name: Falhar se job cr√≠tico de sintaxe falhar
      if: needs.syntax-check.result == 'failure'
      run: |
        echo "‚ùå Job cr√≠tico de sintaxe falhou. Verifique os logs acima."
        exit 1

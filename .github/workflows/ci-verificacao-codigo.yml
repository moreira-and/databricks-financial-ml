test-syntax:
    name: Validação de Sintaxe
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do código
      uses: actions/checkout@v4
      
    - name: Configurar Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Instalar dependências mínimas
      run: |
        pip install pandas requests
        
    - name: Verificar sintaxe Python
      run: |
        python -m py_compile transformacoes/*.py
        python -m py_compile pipelines/*.py
        python -m py_compile utilitarios/*.py
        
    - name: Verificar imports (exceto Databricks)
      run: |
        # Cria estrutura de pacotes mock para bibliotecas do Databricks
        mkdir -p mock_libs/pyspark/sql
        mkdir -p mock_libs/pyspark/dbutils
        
        ############################
        # Mock do módulo dlt
        ############################
        cat > mock_libs/dlt.py << 'EOF'
        """Mock do módulo dlt para validação local."""
        def table(*args, **kwargs):
            def decorator(func):
                return func
            return decorator
        
        def expect(*args, **kwargs):
            def decorator(func):
                return func
            return decorator
        
        def expect_or_drop(*args, **kwargs):
            def decorator(func):
                return func
            return decorator
        
        def expect_or_fail(*args, **kwargs):
            def decorator(func):
                return func
            return decorator
        
        def view(*args, **kwargs):
            def decorator(func):
                return func
            return decorator
        
        def read(*args, **kwargs):
            pass
        
        def read_stream(*args, **kwargs):
            pass
        EOF
        
        ############################
        # Mock do pacote pyspark
        ############################
        # pyspark/__init__.py
        cat > mock_libs/pyspark/__init__.py << 'EOF'
        """Mock do pacote PySpark para validação local."""
        __version__ = "3.5.0"
        EOF
        
        # pyspark/sql/__init__.py
        cat > mock_libs/pyspark/sql/__init__.py << 'EOF'
        """Mock do módulo pyspark.sql para validação local."""

        class DataFrame:
            """Mock do DataFrame do PySpark."""
            def __init__(self, *args, **kwargs):
                pass
            
            def count(self):
                return 0
            
            def repartition(self, *args, **kwargs):
                return self
            
            def sortWithinPartitions(self, *args, **kwargs):
                return self
            
            def select(self, *args, **kwargs):
                return self
            
            def filter(self, *args, **kwargs):
                return self
            
            def withColumn(self, *args, **kwargs):
                return self
            
            def join(self, *args, **kwargs):
                return self

        class types:
            """Mock dos tipos do PySpark."""
            
            class DataType:
                pass
            
            class StructType:
                def __init__(self, fields=None):
                    self.fields = fields or []
                    
                def fieldNames(self):
                    return [f.name for f in self.fields]
            
            class StructField:
                def __init__(self, name, dataType, nullable=True):
                    self.name = name
                    self.dataType = dataType
                    self.nullable = nullable
            
            class StringType(DataType):
                pass
            
            class IntegerType(DataType):
                pass
            
            class LongType(DataType):
                pass
            
            class DoubleType(DataType):
                pass
            
            class FloatType(DataType):
                pass
            
            class TimestampType(DataType):
                pass
            
            class DateType(DataType):
                pass
            
            class BooleanType(DataType):
                pass
            
            class ArrayType(DataType):
                def __init__(self, elementType):
                    self.elementType = elementType

        # Alias para compatibilidade (from pyspark.sql import types as T)
        T = types

        class SparkSession:
            """Mock da SparkSession."""
            
            def __init__(self, *args, **kwargs):
                pass
            
            def createDataFrame(self, data, schema=None):
                return DataFrame()
            
            @property
            def builder(self):
                return self
            
            def appName(self, name):
                return self
            
            def getOrCreate(self):
                return self

        # Instância global mock do spark
        spark = SparkSession()
        EOF
        
        ############################
        # Mock de pyspark.dbutils
        ############################
        # pyspark/dbutils/__init__.py
        cat > mock_libs/pyspark/dbutils/__init__.py << 'EOF'
        """Mock do módulo pyspark.dbutils para validação local."""

        class DBUtils:
            """Mock básico do DBUtils usado no Databricks."""
            def __init__(self, spark=None):
                self.spark = spark
            
            class FS:
                def ls(self, path):
                    return []
                
                def mkdirs(self, path):
                    return None
                
                def rm(self, path, recurse=False):
                    return None
            
            @property
            def fs(self):
                return self.FS()
            
            class Secrets:
                def get(self, scope, key):
                    return ""
            
            @property
            def secrets(self):
                return self.Secrets()
            
            class Widgets:
                def get(self, name):
                    return ""
            
            @property
            def widgets(self):
                return self.Widgets()
        EOF
        
        ############################
        # Ajusta PYTHONPATH e valida imports
        ############################
        export PYTHONPATH="${PYTHONPATH}:$(pwd)/mock_libs"
        
        echo "Validando imports do módulo bronze..."
        python -c "import sys; sys.path.insert(0, 'mock_libs'); import transformacoes.bronze; print('✅ bronze.py OK')"        
        
        echo "Validando imports do módulo prata..."
        python -c "import sys; sys.path.insert(0, 'mock_libs'); import transformacoes.prata; print('✅ prata.py OK')" || echo '⚠️ prata.py não encontrado ou não configurado'
        
        echo "Validando imports do módulo ouro..."
        python -c "import sys; sys.path.insert(0, 'mock_libs'); import transformacoes.ouro; print('✅ ouro.py OK')" || echo '⚠️ ouro.py não encontrado ou não configurado'
        
        echo "Validando imports do módulo configuracoes..."
        python -c "import utilitarios.configuracoes; print('✅ configuracoes.py OK')"
        
        echo "Validando imports do módulo fontes_dados..."
        python -c "import sys; sys.path.insert(0, 'mock_libs'); import utilitarios.fontes_dados; print('✅ fontes_dados.py OK')"
        
        echo "Validando imports do pipeline_financeiro..."
        python -c "import sys; sys.path.insert(0, 'mock_libs'); import pipelines.pipeline_financeiro; print('✅ pipeline_financeiro.py OK')"
